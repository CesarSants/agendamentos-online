<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://xmlns.jcp.org/jsf/html"
    xmlns:f="http://xmlns.jcp.org/jsf/core"
    xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
    xmlns:p="http://primefaces.org/ui"
    lang="pt-BR">
<h:head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agendamento de Consultas</title>
    <script type="text/javascript">
        function handleSaveSuccess() {
            document.getElementById('scheduleForm:clinica').selectedIndex = 0;
            document.getElementById('scheduleForm:medico').selectedIndex = 0;
            document.getElementById('scheduleForm:sala').selectedIndex = 0;
            document.getElementById('scheduleForm:data_input').value = '';
            document.getElementById('scheduleForm:horario_input').value = '';
            document.getElementById('scheduleForm:paciente_input').value = '';
            document.getElementById('scheduleForm:observacoes').value = '';
        }
    </script>
    <h:outputStylesheet>
        .schedule-panel {
            margin: 20px;
        }
        .ui-panel-content {
            padding: 1em;
        }

        .consultas-table {
            margin-top: 10px;
            width: 100%;
        }
        .status-actions {
            display: flex;
            align-items: center;
            gap: 5px;
            justify-content: center;
        }
        .action-button {
            margin-left: 5px;
        }
        .ui-message-error {
            margin: 5px 0;
        }
        .ui-message-success {
            margin: 5px 0;
            background-color: #c8e6c9 !important;
        }
        .selected-datetime {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 4px;
            text-align: center;
        }
        .selected-datetime h3 {
            margin: 0;
            color: #495057;
        }
        .medico-indisponivel {
            color: #dc3545;
            margin: 5px 0;
            font-weight: bold;
        }
        
        .unavailable, .unavailable2 {
            background-color: #ff9999 !important;
            color: #800000 !important;
        }
        /* Aplica ao input do autocomplete quando o componente pai tem a classe unavailable */
        .medicos-autocomplete.unavailable {
            background-color: #ff9999 !important;
            color: #800000 !important;
        }

        .amarelo-autocomplete .ui-autocomplete-input {
            background-color: #fff9b1 !important;
        }

        .unavailable2 .ui-autocomplete-input {
            background-color: #ff9999 !important;
            color: #800000 !important;
        }
        /* Remove background from .unavailable2 itself if needed */
        .unavailable2 {
            background-color: unset !important;
            color: unset !important;
        }
        
        /* Estilos do loader global - igual ao componente clínica */
        .custom-loader-overlay {
            background: rgba(0, 0, 0, 0.7) !important;
            background-color: rgba(0, 0, 0, 0.7) !important;
            z-index: 9999 !important;
        }
        .custom-loader-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            pointer-events: auto !important;
        }
        
        .ui-blockui-content{
            background: rgba(0, 0, 0, 0.4);
        }
        .ui-blockui-content{
        	margin-top: -8px;
            padding: 0;
            z-index: 1;
        }
        
        .custom-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid #764ba2;
            border-top: 6px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 18px;
            box-shadow: 0 0 20px #667eea44;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .custom-loader-text {
            color: #764ba2;
            font-size: 1.3em;
            font-weight: bold;
            letter-spacing: 1px;
            text-shadow: 0 2px 8px #667eea44, 0 0 2px #764ba2;
        }
        
        /* CSS para loaders específicos por ação */
        .action-loader {
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.7);
            z-index: 9999999;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Previne scroll indesejado */
            overflow: hidden;
            /* Garante que o loader ocupe exatamente a viewport */
            max-width: 100vw;
            max-height: 100vh;
        }
        .loader-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        /* Solução para margem do body - igual ao componente clínica */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            box-sizing: border-box;
        }
        
        #body {
            margin: 8px;
        }
        
        .agenda-table-wrapper {
            width: 100%;
        }
        
        .agenda-table-wrapper .ui-datatable-tablewrapper {
            width: 100% !important;
        }
        .agenda-table-wrapper .ui-datatable-scrollable-body {
            overflow-x: auto !important;
            overflow-y: auto !important;
            touch-action: pan-x pan-y !important;
            -webkit-overflow-scrolling: touch !important;
            max-height: 70dvh !important;
        }
        
        

        
        /* Media Queries para Responsividade */
        @media screen and (max-width: 1024px) {
            /* Layout em coluna para tablet */
            .p-grid {
                display: flex;
                flex-direction: column;
                gap: 20px;
            }
            .p-col-6 {
                width: 100% !important;
                flex: none !important;
            }
            
            /* --- SCROLL HORIZONTAL NATIVO NO WRAPPER CORRETO (DEFINITIVO) --- */
            .ui-datatable-tablewrapper {
                overflow-x: scroll !important;
                -webkit-overflow-scrolling: touch !important;
                touch-action: pan-x !important;
                width: 100% !important;
                display: block !important;
                max-width: 100vw !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .ui-datatable-tablewrapper > table {
                min-width: 800px !important;
                width: max-content !important;
                table-layout: auto !important;
            }
            .ui-datatable-data {
                width: 100% !important;
            }
            .ui-datatable-scrollable-body {
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch !important;
                touch-action: pan-x !important;
                width: 100% !important;
                max-width: 100vw !important;
                display: block !important;
            }
            .ui-datatable-scrollable-body > table {
                min-width: 800px !important;
                width: max-content !important;
            }
            /* Dialogs responsivos */
            .ui-dialog, .ui-dialog .ui-dialog-content {
                max-width: 90vw !important;
                width: 100% !important;
                box-sizing: border-box;
            }
            /* Garante que o conteúdo do dialog não ultrapasse */
            .ui-panelgrid, .ui-panel .ui-panel-content {
                max-width: 100%;
                box-sizing: border-box;
                overflow-x: auto;
            }
            /* Sistema de busca responsivo */
            .p-grid .p-col-12 {
                flex-direction: column;
                gap: 10px;
            }
            .p-grid .p-col-12 > * {
                width: 100% !important;
                margin-bottom: 5px;
            }
            /* Botões e selects responsivos */
            .p-grid .p-col-12 .ui-selectonemenu,
            .p-grid .p-col-12 .ui-inputtext,
            .p-grid .p-col-12 .ui-calendar,
            .p-grid .p-col-12 .ui-button {
                width: 100% !important;
                min-width: 0 !important;
                max-width: 100% !important;
                box-sizing: border-box;
            }
            /* Dialog footer responsivo */
            .dialog-footer {
                display: flex;
                flex-direction: column;
                gap: 8px;
                width: 100%;
                box-sizing: border-box;
            }
            .dialog-footer .ui-button {
                width: 100% !important;
                min-width: 0 !important;
                max-width: 100% !important;
            }
        }
        
        .ui-dialog-content  {
        		display: flex !important;
                flex-direction: column !important;
                align-items: center !important;
                text-align: center !important;
                width: 100% !important;
                margin: 0 auto !important;
        }
        
         .button-container {
                display: flex;
                flex-direction: column;
                align-items: center;
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
                box-sizing: border-box;
            }
            
            .ui-panelgrid {
             margin-bottom: 8px;
            }

        @media screen and (max-width: 768px) {
            #body {
                margin: 4px;
            }
            
            /* Ajustes para garantir largura mínima das colunas e scroll horizontal */
            .ui-datatable-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                position: relative;
                width: 100%;
            }
            
            .ui-datatable {
                min-width: 100%;
            }
            
            .ui-datatable table {
                min-width: 675px; /* 135px * 5 colunas */
            }
            
            .ui-datatable .ui-datatable-data td,
            .ui-datatable .ui-datatable-header th {
                min-width: 135px;
                white-space: normal;
                word-wrap: break-word;
            }
            
            /* Coluna de ações precisa ser um pouco maior para acomodar os botões */
            .ui-datatable .action-column {
                min-width: 150px;
            }
            
            /* Scroll suave */
            .ui-datatable-wrapper {
                scroll-behavior: smooth;
            }
            
            /* Estiliza a scrollbar para melhor visualização */
            .ui-datatable-wrapper::-webkit-scrollbar {
                height: 6px;
            }
            
            .ui-datatable-wrapper::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 3px;
            }
            
            .ui-datatable-wrapper::-webkit-scrollbar-thumb {
                background: #888;
                border-radius: 3px;
            }
            
            .ui-datatable-wrapper::-webkit-scrollbar-thumb:hover {
                background: #666;
            }
            
            /* Sistema de busca em mobile */
            .p-grid .p-col-12 {
                gap: 8px;
            }
            .p-grid .p-col-12 > * {
                margin-bottom: 8px;
            }
            
            /* Restante do CSS para 768px permanece igual */
        }

        @media screen and (max-width: 480px) {
            #body {
                margin: 2px;
            }
            
            .ui-panel .ui-panel-content {
                padding: 0.5em;
            }
            
            .button-container {
                display: flex;
                flex-direction: column;
                gap: 5px;
            }
            
            .action-button {
                width: 100%;
                margin-right: 0;
            }
            
            /* Ajusta tamanho dos botões de ação na tabela */
            .action-column .ui-button {
                padding: 0.4em;
                font-size: 0.9em;
            }
            
            /* Melhor visualização da tabela em celulares */
            .ui-datatable-reflow .ui-datatable-data td[role="gridcell"] {
                text-align: left;
                display: block;
                border: 0 none;
                width: 100% !important;
                -webkit-box-sizing: border-box;
                -moz-box-sizing: border-box;
                box-sizing: border-box;
                float: left;
                clear: left;
            }
            
            .ui-datatable-reflow .ui-datatable-data td[role="gridcell"] .ui-column-title {
                padding: .4em;
                min-width: 30%;
                display: inline-block;
                margin: -0.4em 1em -0.4em -0.4em;
                font-weight: bold;
            }
            /* Ajuste extra para mobile */
            .ui-dialog, .ui-dialog .ui-dialog-content {
                max-width: 98vw !important;
            }
            
            /* Sistema de busca em mobile pequeno */
            .p-grid .p-col-12 {
                gap: 5px;
            }
            .p-grid .p-col-12 > * {
                margin-bottom: 5px;
            }
        }

        @media screen and (max-height: 600px) {
            .custom-loader-container {
                height: 100%;
            }
            
            .ui-dialog {
                max-height: 90vh !important;
                overflow-y: auto;
            }
        }
        
        /* Resto do CSS existente permanece inalterado */

    </h:outputStylesheet>
    <style type="text/css">
        .dynamic-info {
            margin-top: 5px;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 4px;
            font-size: 0.9em;
            color: #495057;
        }
    </style>
</h:head>
<h:body>
    <!-- Loader global -->
    <p:blockUI block="@all" widgetVar="globalLoader" styleClass="custom-loader-overlay">
        <div class="custom-loader-container">
            <div class="custom-spinner"></div>
            <div class="custom-loader-text">Carregando...</div>
        </div>
    </p:blockUI>
    <h:outputScript>
    function showLoaderAndDisable(btnId) {
        PF('globalLoader').show();
    }
    function hideLoaderAndEnable(btnId) {
        PF('globalLoader').hide();
    }
    </h:outputScript>
    <div id="body">
    <ui:include src="/WEB-INF/templates/menu.xhtml" />
      <p:messages id="msgs" showDetail="true" closable="true">
        <p:autoUpdate />
    
	  </p:messages>    
	  
	  
	  <p:panel header="Agendamento de Consultas">        
    
    			<!-- 
    			<h:form id="datetimeForm">            

    			<p:outputPanel id="datetime-panel">
                
                <p:outputPanel rendered="#{not empty agendaController.dynamicDateTime}">
                    <div class="selected-datetime">
                        <h3>Horário selecionado: 
                            <h:outputText id="datetime-display" value="#{agendaController.dynamicDateTime}" />
                        </h3>
                    </div>
                </p:outputPanel>
            </p:outputPanel>

            <p:outputPanel id="horario">
                <p:outputPanel rendered="#{not empty agendaController.selectedTime}">
                    <div class="selected-datetime">
                        <h3>Horário: 
                            <h:outputText value="#{agendaController.selectedTime}" />
                        </h3>
                    </div>
                </p:outputPanel>
            </p:outputPanel>

            <p:outputPanel id="medico-panel">
                <p:outputPanel rendered="#{not empty agendaController.dynamicSelectedMedico}">
                    <div class="selected-datetime">
                        <h3>Médico selecionado: 
                            <h:outputText id="medico-display" value="#{agendaController.dynamicSelectedMedico}" />
                        </h3>
                    </div>
                </p:outputPanel>
            </p:outputPanel>
            
            <p:outputPanel id="medicos-indisponiveis-panel">
                <p:outputPanel rendered="#{not empty agendaController.dynamicDateTime and not empty agendaController.medicosIndisponiveisNomes}">
                    <div class="selected-datetime">
                        <h3>Médicos indisponíveis no horário #{agendaController.dynamicDateTime}:</h3>
                        <ui:repeat value="#{agendaController.medicosIndisponiveisNomes}" var="medicoNome">
                            <p class="medico-indisponivel">
                                <h:outputText value="#{medicoNome}" />
                            </p>
                        </ui:repeat>
                    </div>
                </p:outputPanel>
            </p:outputPanel>
            
            <p:outputPanel id="clinica-panel">
                <p:outputPanel rendered="#{not empty agendaController.dynamicSelectedClinica}">
                    <div class="selected-datetime">
                        <h3>Clínica selecionada: 
                            <h:outputText id="clinica-display" value="#{agendaController.dynamicSelectedClinica}" />
                        </h3>
                    </div>
                </p:outputPanel>
            </p:outputPanel>

            <p:outputPanel id="sala-panel">
                <p:outputPanel rendered="#{not empty agendaController.dynamicSelectedSala}">
                    <div class="selected-datetime">
                        <h3>Sala selecionada: 
                            <h:outputText id="sala-display" value="#{agendaController.dynamicSelectedSala}" />
                        </h3>
                    </div>
                </p:outputPanel>
            </p:outputPanel>

            <p:outputPanel id="paciente-panel">
                <p:outputPanel rendered="#{not empty agendaController.dynamicSelectedPaciente}">
                    <div class="selected-datetime">
                        <h3>Paciente selecionado: 
                            <h:outputText id="paciente-display" value="#{agendaController.dynamicSelectedPaciente}" />
                        </h3>
                    </div>
                </p:outputPanel>
            </p:outputPanel>
            
            <p:outputPanel id="pacientes-indisponiveis-panel">
                <p:outputPanel rendered="#{not empty agendaController.dynamicDateTime and not empty agendaController.pacientesIndisponiveisNomes}">
                    <div class="selected-datetime">
                        <h3>Pacientes indisponíveis no horário #{agendaController.dynamicDateTime}:</h3>
                        <ui:repeat value="#{agendaController.pacientesIndisponiveisNomes}" var="pacienteNome">
                            <p class="medico-indisponivel">
                                <h:outputText value="#{pacienteNome}" />
                            </p>
                        </ui:repeat>
                    </div>
                </p:outputPanel>
            </p:outputPanel>
            
            <p:outputPanel id="salas-indisponiveis-panel">
                <p:outputPanel rendered="#{not empty agendaController.dynamicDateTime and not empty agendaController.salasIndisponiveisNomes}">
                    <div class="selected-datetime">
                        <h3>Salas indisponíveis no horário #{agendaController.dynamicDateTime}:</h3>
                        <ui:repeat value="#{agendaController.salasIndisponiveisNomes}" var="salaNome">
                            <p class="medico-indisponivel">
                                <h:outputText value="#{salaNome}" />
                            </p>
                        </ui:repeat>
                    </div>
                </p:outputPanel>
            </p:outputPanel>
        </h:form>
        -->
        <div class="p-grid">
            <div class="p-col-6">
                <!-- Calendário e Formulário de Agendamento -->
                <p:panel header="Nova Consulta" styleClass="schedule-panel">
                    <h:form id="scheduleForm">
                        <p:panelGrid columns="2" layout="grid" styleClass="ui-fluid">
                            <p:outputLabel for="clinica" value="Clínica:" />
                            <p:selectOneMenu id="clinica" value="#{agendaController.selectedClinicaId}" 
                                           required="true" style="width: 100%;">
                                <f:selectItem itemLabel="Selecione uma clínica" itemValue="" />
                                <f:selectItems value="#{agendaController.clinicas}" 
                                             var="clinica" 
                                             itemLabel="#{clinica.nome}" 
                                             itemValue="#{clinica.id}" />
                                <!-- <p:ajax update="scheduleForm:medico scheduleForm:sala scheduleForm:paciente,:datetimeForm:clinica-panel,:datetimeForm:pacientes-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel" -->
                                     <p:ajax update="scheduleForm:medico scheduleForm:sala scheduleForm:paciente,:msgs"  
                                       listener="#{agendaController.onClinicaChange}" />
                            </p:selectOneMenu> 
                            


                            <p:outputLabel for="medico" value="Médico:" />                                
                            <p:autoComplete id="medico"
                                            value="#{agendaController.selectedMedico}"
                                            completeMethod="#{agendaController.buscarMedicosDaClinica}" 
                                            var="medico"
                                            placeholder="Digite o nome do medico"
                                            itemLabel="#{medico.nome}"
                                            itemValue="#{medico}"
                                            converter="medicoConverter"
                                            dropdown="true"
                                            forceSelection="true"
                                            required="true"
                                            cache="true"
                                            emptyMessage="Nenhum médico encontrado"
                                            scrollHeight="200"
                                            disabled="#{empty agendaController.selectedClinicaId}"
                                            panelStyleClass="custom-autocomplete-panel"
                                            styleClass="#{agendaController.getMedicoInputUnavailableClass()}">
                                <p:column styleClass="#{agendaController.getItemStyleClass(medico.nome)}">
                                    <h:outputText value="#{medico.nome}" />
                                </p:column>
                                <p:ajax event="itemSelect"
                                        listener="#{agendaController.onMedicoChange}"
                                        update="horario,scheduleForm:medico,:msgs" />
                                        <!-- update="horario,:datetimeForm:medico-panel,scheduleForm:medico,:datetimeForm:medicos-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel,:datetimeForm:datetime-panel,:msgs" />-->
                                <p:ajax event="change"
                                        listener="#{agendaController.onMedicoChange}"
                                        update="horario,scheduleForm:medico,:msgs" />
                                        <!-- update="horario,:datetimeForm:medico-panel,scheduleForm:medico,:datetimeForm:medicos-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel,:datetimeForm:datetime-panel,:msgs" />-->
                            </p:autoComplete>

                            
                            
                            <p:outputLabel for="sala" value="Sala:" />
                            <p:autoComplete id="sala" 
                                value="#{agendaController.selectedSala}"
                                completeMethod="#{agendaController.buscarSalasDaClinica}"
                                var="sala"
                                itemLabel="#{sala.nome}"
                                itemValue="#{sala}"
                                converter="salaConverter"
                                dropdown="true"
                                forceSelection="true"
                                required="true"
                                cache="true"
                                emptyMessage="Nenhuma sala encontrada"
                                placeholder="Digite o nome da sala"
                                requiredMessage="Selecione uma sala"
                                scrollHeight="200"
                                disabled="#{empty agendaController.selectedClinicaId}"
                                panelStyleClass="custom-autocomplete-panel"
                                styleClass="#{agendaController.getSalaInputUnavailableClass()}">
                                <p:column styleClass="#{agendaController.getSalaItemStyleClass(sala.nome)}">
                                    <h:outputText value="#{sala.nome}" />
                                </p:column>
                                <p:ajax event="itemSelect" 
                                    listener="#{agendaController.onSalaChange}"
                                    update=":msgs,scheduleForm:sala" />
                                    <!-- update=":datetimeForm:sala-panel,:datetimeForm:salas-indisponiveis-panel,:datetimeForm:horario,:datetimeForm:datetime-panel,:msgs,scheduleForm:sala" />-->
                                <p:ajax event="change" 
                                    listener="#{agendaController.onSalaChange}"
                                    update=":msgs,scheduleForm:sala" />
                                   <!-- update=":datetimeForm:sala-panel,:datetimeForm:salas-indisponiveis-panel,:datetimeForm:horario,:datetimeForm:datetime-panel,:msgs,scheduleForm:sala" />-->
                            </p:autoComplete>
                            
                            <p:outputLabel for="data" value="Data:" />                            
                            <p:datePicker id="data" value="#{agendaController.selectedDate}" 
                                        required="true" pattern="dd/MM/yyyy" 
                                        mindate="#{agendaController.today}"
                                        showTime="false"
                                        keyboardInput="true"
                                        converterMessage="Formato de data inválido. Use dd/MM/yyyy">
                                <!--<p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:datetimeForm:datetime-panel,:datetimeForm:pacientes-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel,:msgs"--> 
                                    <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:msgs"     
                                        execute="@this" 
                                        listener="#{agendaController.onDataChange}" 
                                        event="dateSelect"
                                        immediate="true"
                                        process="@this" />
                               <!-- <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:datetimeForm:datetime-panel,:datetimeForm:pacientes-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel,:msgs"--> 
                                    <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:msgs" 
                                        execute="@this" 
                                        listener="#{agendaController.onDataChange}" 
                                        event="change"
                                        immediate="true"
                                        process="@this" />
                                <!-- <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:datetimeForm:datetime-panel,:datetimeForm:pacientes-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel,:msgs"--> 
                                     <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:msgs" 
                                        execute="@this" 
                                        listener="#{agendaController.onDataChange}" 
                                        event="keyup"
                                        immediate="true"
                                        process="@this" />
                            </p:datePicker>
                            
                            <p:outputLabel for="horario" value="Horário:" />                            
                            <p:calendar id="horario" 
                                      value="#{agendaController.selectedTime}" 
                                      pattern="HH:mm" 
                                      timeOnly="true"
                                      required="true"
                                      keyboardInput="true"
                                      hideOnDateTimeSelect="false"
                                      showTime="true"
                                      autoClose="false"
                                      showButtonPanel="true"
                                      converterMessage="Formato de hora inválido. Use HH:mm (24h)">
                                <!-- <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:datetimeForm:datetime-panel,:datetimeForm:pacientes-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel,:msgs"--> 
                                     <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:msgs" 
                                        execute="@this" 
                                        listener="#{agendaController.onDataChange}" 
                                        event="dateSelect"
                                        immediate="true"
                                        process="@this" />
                                <!-- <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:datetimeForm:datetime-panel,:datetimeForm:pacientes-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel,:msgs"--> 
                                     <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:msgs" 
                                        execute="@this" 
                                        listener="#{agendaController.onDataChange}" 
                                        event="change"
                                        immediate="true"
                                        delay="700"
                                        process="@this" />
                                <!-- <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:datetimeForm:datetime-panel,:datetimeForm:pacientes-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel,:msgs"--> 
                                     <p:ajax update="horario,scheduleForm:medico,scheduleForm:paciente,scheduleForm:sala,:msgs" 
                                        execute="@this" 
                                        listener="#{agendaController.onDataChange}" 
                                        event="keyup"
                                        immediate="true"
                                        process="@this" />
                            </p:calendar>
                            
                            <p:outputLabel for="paciente" value="Paciente:" />                            
                            <p:autoComplete id="paciente" 
                                          value="#{agendaController.selectedPaciente}"
                                          completeMethod="#{agendaController.completePaciente}"
                                          var="paciente"
                                          placeholder="Digite o nome do paciente"
                                          itemLabel="#{paciente.nome}"
                                          itemValue="#{paciente}"
                                          converter="pacienteConverter"
                                          dropdown="true"
                                          forceSelection="true"
                                          required="true"
                                          cache="true"
                                          emptyMessage="Nenhum paciente encontrado"
                                          scrollHeight="200"
                                          panelStyleClass="custom-autocomplete-panel"
                                          styleClass="#{agendaController.getPacienteInputUnavailableClass()}">
                                <p:column styleClass="#{agendaController.getPacienteItemStyleClass(paciente.nome)}">
                                    <h:outputText value="#{paciente.nome}" />
                                </p:column>
                                <p:ajax event="itemSelect"
                                        listener="#{agendaController.onPacienteChange}"
                                        update=":msgs,scheduleForm:paciente" />
                                        <!--update=":datetimeForm:paciente-panel,scheduleForm:paciente,:datetimeForm:pacientes-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel,:datetimeForm:datetime-panel,:msgs" />-->
                                <p:ajax event="change"
                                        listener="#{agendaController.onPacienteChange}"
                                        update=":msgs,scheduleForm:paciente" />
                                        <!-- update=":datetimeForm:paciente-panel,scheduleForm:paciente,:datetimeForm:pacientes-indisponiveis-panel,:datetimeForm:salas-indisponiveis-panel,:datetimeForm:datetime-panel,:msgs" />-->
                            </p:autoComplete>

                            <p:outputLabel for="observacoes" value="Observações:" />
                            <p:inputTextarea id="observacoes" value="#{agendaController.observacoes}" 
                                           rows="3" />
                        </p:panelGrid>                        <p:commandButton value="Agendar" 
                                       action="#{agendaController.salvarAgendamento}"
                                       process="@form"
                                       update=":scheduleForm :consultasForm:consultasTable :msgs"
                                       icon="pi pi-calendar-plus"
                                       styleClass="ui-button-success"
                                       onclick="showLoaderAgendar()" 
                                       oncomplete="hideLoaderAgendar();if (!args.validationFailed) handleSaveSuccess()"/>
                    </h:form>
                </p:panel>

                <!-- Sistema de Atualização Automática -->
                <p:panel header="Sistema de Atualização Automática" styleClass="schedule-panel">
                    <h:form id="toggleForm">
                        <div class="p-grid" style="margin-bottom: 10px;">
                            <div class="p-col-12" style="display: flex; align-items: center; gap: 10px;">
                                <p:commandButton id="toggleButton"
                                               value="#{agendaController.sistemaAtualizacaoAtivo ? 'Desativar' : 'Ativar'} Sistema"
                                               action="#{agendaController.toggleSistemaAtualizacao}"
                                               update="pollPanel statusMessage toggleButton"
                                               styleClass="#{agendaController.sistemaAtualizacaoAtivo ? 'ui-button-danger' : 'ui-button-success'}"
                                               style="width: auto;" />
                                <h:panelGroup id="statusMessage">
                                    <div 
                                         style="padding: 8px 12px; border-radius: 4px; #{agendaController.sistemaAtualizacaoAtivo ? 'background-color: #c8e6c9;' : 'background-color: #ffcdd2;'}">
                                        <h:outputText value="#{agendaController.sistemaAtualizacaoAtivo ? 'Sistema de atualização automática ATIVO' : 'Sistema de atualização automática INATIVO'}"
                                                    style="#{agendaController.sistemaAtualizacaoAtivo ? 'color: #2e7d32;' : 'color: #c62828;'}" />
                                    </div>
                                </h:panelGroup>
                            </div>
                        </div>
                    </h:form>
                </p:panel>

                <!-- Sistema de Busca -->
                <p:panel header="Buscar Agendamentos" styleClass="schedule-panel">
                    <h:form id="searchForm">
                        <div class="p-grid" style="margin-bottom: 10px;">
                            <div class="p-col-12" style="display: flex; align-items: center; gap: 10px;">
                                <!-- Primeiro Seletor - Tipo de Entidade -->
                                <p:selectOneMenu id="searchEntityType" value="#{agendaController.searchEntityType}"
                                               style="width: 150px;">
                                    <f:selectItem itemLabel="Data/Hora" itemValue="data"/>
                                    <f:selectItem itemLabel="Paciente" itemValue="paciente"/>
                                    <f:selectItem itemLabel="Médico" itemValue="medico"/>
                                    <f:selectItem itemLabel="Clínica" itemValue="clinica"/>
                                    <p:ajax update="searchTypePanel searchInputPanel" 
                                           listener="#{agendaController.onSearchEntityTypeChange}"/>
                                </p:selectOneMenu>

                                <!-- Segundo Seletor - Tipo de Busca -->
                                <h:panelGroup id="searchTypePanel">
                                    <!-- Seletor para Paciente -->
                                    <p:selectOneMenu id="searchTypePaciente" value="#{agendaController.searchType}"
                                                   style="width: 150px;"
                                                   rendered="#{agendaController.searchEntityType eq 'paciente'}">
                                        <f:selectItem itemLabel="Nome" itemValue="nome"/>
                                        <f:selectItem itemLabel="CPF" itemValue="cpf"/>
                                        <f:selectItem itemLabel="Telefone" itemValue="telefone"/>
                                        <f:selectItem itemLabel="Endereço" itemValue="endereco"/>
                                        <p:ajax update="searchInputPanel" listener="#{agendaController.clearSearch}"/>
                                    </p:selectOneMenu>
                                    
                                    <!-- Seletor para Médico -->
                                    <p:selectOneMenu id="searchTypeMedico" value="#{agendaController.searchType}"
                                                   style="width: 150px;"
                                                   rendered="#{agendaController.searchEntityType eq 'medico'}">
                                        <f:selectItem itemLabel="Nome" itemValue="nome"/>
                                        <f:selectItem itemLabel="CPF" itemValue="cpf"/>
                                        <f:selectItem itemLabel="Endereço" itemValue="endereco"/>
                                        <p:ajax update="searchInputPanel" listener="#{agendaController.clearSearch}"/>
                                    </p:selectOneMenu>
                                    
                                    <!-- Seletor para Clínica -->
                                    <p:selectOneMenu id="searchTypeClinica" value="#{agendaController.searchType}"
                                                   style="width: 150px;"
                                                   rendered="#{agendaController.searchEntityType eq 'clinica'}">
                                        <f:selectItem itemLabel="Nome" itemValue="nome"/>
                                        <f:selectItem itemLabel="CNPJ" itemValue="cnpj"/>
                                        <f:selectItem itemLabel="Endereço" itemValue="endereco"/>
                                        <p:ajax update="searchInputPanel" listener="#{agendaController.clearSearch}"/>
                                    </p:selectOneMenu>
                                </h:panelGroup>

                                <!-- Campo de Busca -->
                                <h:panelGroup id="searchInputPanel" style="flex-grow: 1;">
                                    <!-- Data/Hora -->
                                    <p:calendar id="searchDate" 
                                              value="#{agendaController.searchDate}"
                                              pattern="dd/MM/yyyy"
                                              rendered="#{agendaController.searchEntityType eq 'data'}"
                                              placeholder="Selecione a data">
                                        <p:ajax event="dateSelect" listener="#{agendaController.filterAgendamentos}"
                                               update=":consultasForm:consultasTable"
                                               onstart="showLoaderBuscar()" 
                                               oncomplete="hideLoaderBuscar()"/>
                                        <p:ajax event="change" listener="#{agendaController.filterAgendamentos}"
                                               update=":consultasForm:consultasTable"
                                               onstart="showLoaderBuscar()" 
                                               oncomplete="hideLoaderBuscar()"/>
                                    </p:calendar>

                                    <p:calendar id="searchTime" 
                                              value="#{agendaController.searchTime}"
                                              pattern="HH:mm"
                                              timeOnly="true"
                                              rendered="#{agendaController.searchEntityType eq 'data' or (agendaController.searchEntityType eq 'clinica' and agendaController.searchType eq 'horario')}"
                                              placeholder="Selecione o horário"
                                              style="margin-left: 10px;"
                                              widgetVar="searchTimeWidget"
                                              showButtonPanel="true"
                                              autoClose="true">
                                        <p:ajax event="dateSelect" listener="#{agendaController.filterAgendamentos}"
                                               update=":consultasForm:consultasTable"
                                               onstart="showLoaderBuscar()" 
                                               oncomplete="hideLoaderBuscar()"/>
                                    </p:calendar>

                                    <!-- Campo de texto para outras buscas -->
                                    <p:inputText id="searchText"
                                               value="#{agendaController.searchText}"
                                               rendered="#{agendaController.searchEntityType ne 'data' and not (agendaController.searchEntityType eq 'clinica' and agendaController.searchType eq 'horario')}"
                                               placeholder="Digite para buscar..."
                                               style="width: 100%;">
                                        <p:ajax event="keyup" listener="#{agendaController.filterAgendamentos}"
                                               update=":consultasForm:consultasTable"
                                               onstart="showLoaderBuscar()" 
                                               oncomplete="hideLoaderBuscar()"/>
                                    </p:inputText>
                                </h:panelGroup>

                                <!-- Botão Limpar -->
                                <p:commandButton value="Limpar" 
                                               action="#{agendaController.clearSearch}"
                                               update="searchForm :consultasForm:consultasTable"
                                               onclick="showLoaderBuscar()" 
                                               oncomplete="hideLoaderBuscar()"
                                               icon="pi pi-times"/>
                                
                                <!-- Seletor de Ordenação -->
                                <p:outputLabel value="Ordenar por:" style="font-weight: bold; margin-left: 20px;" />
                                <p:selectOneMenu value="#{agendaController.ordenacao}"
                                               style="width: 200px;">
                                    <f:selectItem itemLabel="Data (mais recente primeiro)" itemValue="data_recente"/>
                                    <f:selectItem itemLabel="Data (mais antiga primeiro)" itemValue="data_antiga"/>
                                    <f:selectItem itemLabel="Clínica" itemValue="clinica"/>
                                    <f:selectItem itemLabel="Médico" itemValue="medico"/>
                                    <f:selectItem itemLabel="Paciente" itemValue="paciente"/>
                                    <p:ajax update=":consultasForm:consultasTable" 
                                           listener="#{agendaController.onOrdenacaoChange}"
                                           onstart="showLoaderBuscar()" 
                                           oncomplete="hideLoaderBuscar()"/>
                                </p:selectOneMenu>
                            </div>
                        </div>
                    </h:form>
                </p:panel>
            </div>

            <div class="p-col-6">
                <!-- Lista de Consultas -->
                <p:panel header="Consultas Agendadas" styleClass="schedule-panel">
                    <h:form id="consultasForm">                        
                        <div class="agenda-table-wrapper">
                            <p:dataTable id="consultasTable" 
                                widgetVar="consultasTable"
                                var="consulta" 
                                value="#{agendaController.agendasFiltradas}"
                                rows="10" 
                                paginator="true"
                                paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                currentPageReportTemplate="{startRecord}-{endRecord} de {totalRecords} registros"
                                rowsPerPageTemplate="5,10,15"
                                emptyMessage="Nenhuma consulta encontrada"
                                lazy="false"
                                styleClass="consultas-table"
                                scrollable="true" scrollWidth="100%">
                            <p:ajax event="page" ignoreAutoUpdate="true" />
                            <p:autoUpdate />
                            <p:column headerText="Data/Hora" width="135">
                                <h:outputText value="#{consulta.dataHora}">
                                    <f:convertDateTime pattern="dd/MM/yyyy HH:mm" type="localDateTime"/>
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Paciente" width="135">
                                <h:outputText value="#{consulta.paciente.nome}" />
                            </p:column>

                            <p:column headerText="Médico" width="135">
                                <h:outputText value="#{consulta.medico.nome}" />
                            </p:column>                            <p:column headerText="Clínica/Sala" width="135">
                                <h:outputText value="#{consulta.clinica.nome} - #{consulta.sala.nome}" />
                            </p:column>                            <p:column headerText="Status" width="135">
                                <div class="status-actions">
                                    <p:tag styleClass="#{consulta.status.cssClass}" 
                                           value="#{consulta.status.descricao}" 
                                           severity="#{consulta.status.severity}" />                                    <p:commandButton icon="pi pi-check"
                                                   action="#{agendaController.finalizarConsulta(consulta)}"
                                                   update=":consultasForm:consultasTable :msgs @form"
                                                   styleClass="ui-button-success rounded-button action-button"
                                                   rendered="#{consulta.status.name() eq 'AGENDADO'}"
                                                   title="Finalizar Consulta"
                                                   onclick="showLoaderFinalizar()" 
                                                   oncomplete="hideLoaderFinalizar()"
                                                   process="@this">
                                        <p:confirm header="Confirmação" 
                                                  message="Deseja finalizar esta consulta?" 
                                                  icon="pi pi-exclamation-triangle" />
                                    </p:commandButton>                                    <p:commandButton icon="pi pi-times"
                                                   action="#{agendaController.cancelarConsulta(consulta)}"
                                                   update=":consultasForm:consultasTable :msgs @form"
                                                   styleClass="ui-button-warning rounded-button action-button"
                                                   rendered="#{consulta.status.name() eq 'AGENDADO'}"
                                                   title="Cancelar Consulta"
                                                   onclick="showLoaderCancelar()" 
                                                   oncomplete="hideLoaderCancelar()"
                                                   process="@this">
                                        <p:confirm header="Confirmação" 
                                                  message="Deseja cancelar esta consulta?" 
                                                  icon="pi pi-exclamation-triangle" />
                                    </p:commandButton>
                                    
                                </div>
                            </p:column>                            
                            <p:column headerText="Ações" styleClass="action-column" width="150">                                
                            <div class="status-actions">
                                    <p:commandButton icon="pi pi-eye" 
                     onclick="showLoaderDetalhes()"
                     oncomplete="hideLoaderDetalhes();PF('detalhesDialog').show()"
                     update=":detalhesForm"
                     styleClass="ui-button-info rounded-button"
                     title="Visualizar Detalhes">
        <f:setPropertyActionListener value="#{consulta}" 
                                   target="#{agendaController.selectedConsulta}" />
    </p:commandButton>
    
    <p:commandButton icon="pi pi-pencil"
                     action="#{agendaController.prepararEdicao(consulta)}"
                     onclick="showLoaderEditar()"
                     oncomplete="hideLoaderEditar();PF('editDialog').show()"
                     update=":editForm"
                     styleClass="ui-button-warning rounded-button"
                     title="Editar Agendamento" />                                    
                     			   <p:commandButton icon="pi pi-trash" 
                                                   action="#{agendaController.excluirConsulta(consulta)}"
                                                   update=":consultasForm:consultasTable :msgs @form"
                                                   styleClass="ui-button-danger rounded-button action-button"
                                                   title="Excluir Consulta"
                                                   onclick="showLoaderExcluir()" 
                                                   oncomplete="hideLoaderExcluir()">
                                        <p:confirm header="Confirmação" 
                                                  message="Deseja excluir esta consulta?" 
                                                  icon="pi pi-exclamation-triangle" />
                                    </p:commandButton>
                                </div>
                            </p:column>
                        </p:dataTable>
                    </div>
                </h:form>
            </p:panel>
            </div>
        </div>
    </p:panel>

    <!-- Dialog de Detalhes da Consulta -->
    <p:dialog header="Detalhes da Consulta" widgetVar="detalhesDialog" 
              modal="true" showEffect="fade" hideEffect="fade" width="500">
        <h:form id="detalhesForm">
            <p:panelGrid columns="2" columnClasses="label,value" rendered="#{not empty agendaController.selectedConsulta}">
                <h:outputText value="Paciente:" />
                <h:outputText value="#{agendaController.selectedConsulta.paciente.nome}" />                <h:outputText value="Médico:" />
                <h:outputText value="#{agendaController.selectedConsulta.medico.nome}" />

                <h:outputText value="Clínica:" />
                <h:outputText value="#{agendaController.selectedConsulta.clinica.nome}" />

                <h:outputText value="Sala:" />
                <h:outputText value="#{agendaController.selectedConsulta.sala.nome}" />

                <h:outputText value="Data/Hora Início:" />
                <h:outputText value="#{agendaController.selectedConsulta.dataHora}">
                    <f:convertDateTime pattern="dd/MM/yyyy HH:mm" type="localDateTime"/>
                </h:outputText>

                <h:outputText value="Data/Hora Fim:" />
                <h:outputText value="#{agendaController.selectedConsulta.dataHoraFim}">
                    <f:convertDateTime pattern="dd/MM/yyyy HH:mm" type="localDateTime"/>
                </h:outputText>

                <h:outputText value="Status:" />
                <p:tag value="#{agendaController.selectedConsulta.status.descricao}"
                       severity="#{agendaController.selectedConsulta.status.severity}"
                       styleClass="#{agendaController.selectedConsulta.status.cssClass}" />

                <h:outputText value="Observações:" />
                <h:outputText value="#{agendaController.selectedConsulta.observacoes}" 
                             rendered="#{not empty agendaController.selectedConsulta.observacoes}"/>
                <h:outputText value="Nenhuma observação" 
                             rendered="#{empty agendaController.selectedConsulta.observacoes}"/>
            </p:panelGrid>
        </h:form>
    </p:dialog>

    <!-- Dialog para Editar Consulta -->
<p:dialog header="Editar Consulta" widgetVar="editDialog" 
          modal="true" showEffect="fade" hideEffect="fade" 
          width="500">
    <h:form id="editForm">
        <!-- Para status AGENDADO - campos editáveis -->
        <p:panelGrid columns="2" columnClasses="label,value" rendered="#{not empty agendaController.selectedConsulta and agendaController.selectedConsulta.status.name() eq 'AGENDADO'}">
            <h:outputText value="Paciente:" />
            <h:outputText value="#{agendaController.selectedConsulta.paciente.nome}" />

            <h:outputText value="Clínica:" />
            <h:outputText value="#{agendaController.selectedConsulta.clinica.nome}" />

            <p:outputLabel for="editMedicoId" value="Médico:" />
            <p:autoComplete id="editMedicoId"
                          value="#{agendaController.editMedico}"
                          completeMethod="#{agendaController.getMedicosDisponiveisParaEdicao}"
                          var="medico"
                          itemLabel="#{medico.nome}"
                          itemValue="#{medico}"
                          converter="medicoConverter"
                          dropdown="true"
                          forceSelection="true"
                          required="true"
                          cache="true"
                          emptyMessage="Nenhum médico encontrado"
                          scrollHeight="200"
                          panelStyleClass="custom-autocomplete-panel"
                          disabled="#{agendaController.isMedicoEditDisabled()}"
                          placeholder="#{agendaController.getMedicoEditPlaceholder()}"
                          styleClass="#{agendaController.getMedicoEditInputClass()}">
                <p:column>
                    <h:outputText value="#{medico.nome}" />
                </p:column>
                <p:ajax event="itemSelect"
                        update=":editForm :msgs" />
                <p:ajax event="change"
                        update=":editForm :msgs" />
            </p:autoComplete>

            <p:outputLabel for="editData" value="Data/Hora:" />
            <p:calendar id="editData" 
                      value="#{agendaController.editDataHora}" 
                      pattern="dd/MM/yyyy HH:mm"
                      showTime="true"
                      required="true">
                <p:ajax event="dateSelect" 
                       update=":editForm:editMedicoId :editForm:editSalaId :msgs" 
                       listener="#{agendaController.updateDynamicEditDateTime}" />
                <p:ajax event="change"
                       update=":editForm:editMedicoId :editForm:editSalaId :msgs"
                       listener="#{agendaController.updateDynamicEditDateTime}" />
            </p:calendar>

            <p:outputLabel for="editSalaId" value="Sala:" />
            <p:autoComplete id="editSalaId"
                          value="#{agendaController.editSala}"
                          completeMethod="#{agendaController.buscarSalasDisponiveisParaEdicao}"
                          var="sala"
                          itemLabel="#{sala.nome}"
                          itemValue="#{sala}"
                          converter="salaConverter"
                          dropdown="true"
                          forceSelection="true"
                          required="true"
                          cache="true"
                          emptyMessage="Nenhuma sala encontrada"
                          scrollHeight="200"
                          panelStyleClass="custom-autocomplete-panel"
                          disabled="#{agendaController.isSalaEditDisabled()}"
                          placeholder="#{agendaController.getSalaEditPlaceholder()}"
                          styleClass="#{agendaController.getSalaEditInputClass()}">
                <p:column>
                    <h:outputText value="#{sala.nome}" />
                </p:column>
                <p:ajax event="itemSelect"
                        update=":editForm :msgs"
                        listener="#{agendaController.onSalaEditChange}" />
                <p:ajax event="change"
                        update=":editForm :msgs"
                        listener="#{agendaController.onSalaEditChange}" />
            </p:autoComplete>

            <p:outputLabel for="editObservacoesId" value="Observações:" />
            <p:inputTextarea id="editObservacoesId" 
                          value="#{agendaController.editObservacoes}" />
        </p:panelGrid>

        <!-- Para status não-AGENDADO - igual ao visualizador mas com observações editável -->
        <p:panelGrid columns="2" columnClasses="label,value" rendered="#{not empty agendaController.selectedConsulta and agendaController.selectedConsulta.status.name() ne 'AGENDADO'}">
            <h:outputText value="Paciente:" />
            <h:outputText value="#{agendaController.selectedConsulta.paciente.nome}" />
            
            <h:outputText value="Médico:" />
            <h:outputText value="#{agendaController.selectedConsulta.medico.nome}" />

            <h:outputText value="Clínica:" />
            <h:outputText value="#{agendaController.selectedConsulta.clinica.nome}" />

            <h:outputText value="Sala:" />
            <h:outputText value="#{agendaController.selectedConsulta.sala.nome}" />

            <h:outputText value="Data/Hora Início:" />
            <h:outputText value="#{agendaController.selectedConsulta.dataHora}">
                <f:convertDateTime pattern="dd/MM/yyyy HH:mm" type="localDateTime"/>
            </h:outputText>

            <h:outputText value="Data/Hora Fim:" />
            <h:outputText value="#{agendaController.selectedConsulta.dataHoraFim}" 
                        rendered="#{not empty agendaController.selectedConsulta.dataHoraFim}">
                <f:convertDateTime pattern="dd/MM/yyyy HH:mm" type="localDateTime"/>
            </h:outputText>
            <h:outputText value="#{agendaController.selectedConsulta.dataHora.plusMinutes(agendaController.selectedConsulta.medico.tempoConsulta)}" 
                        rendered="#{empty agendaController.selectedConsulta.dataHoraFim and not empty agendaController.selectedConsulta.dataHora and not empty agendaController.selectedConsulta.medico.tempoConsulta}">
                <f:convertDateTime pattern="dd/MM/yyyy HH:mm" type="localDateTime"/>
            </h:outputText>
            <h:outputText value="N/A" 
                        rendered="#{empty agendaController.selectedConsulta.dataHoraFim and (empty agendaController.selectedConsulta.dataHora or empty agendaController.selectedConsulta.medico.tempoConsulta)}"/>

            <h:outputText value="Status:" />
            <p:tag value="#{agendaController.selectedConsulta.status.descricao}"
                   severity="#{agendaController.selectedConsulta.status.severity}"
                   styleClass="#{agendaController.selectedConsulta.status.cssClass}" />

            <h:outputText value="Observações:" />
            <p:inputTextarea id="editObservacoesId2" 
                          value="#{agendaController.editObservacoes}" />
        </p:panelGrid>

        <div class="dialog-footer">
            <p:commandButton value="Salvar" 
                           action="#{agendaController.salvarEdicao}"
                           update=":consultasForm:consultasTable :msgs @form"
                           onclick="showLoaderEditar()" 
                           oncomplete="hideLoaderEditar();if (!args.validationFailed) PF('editDialog').hide()"
                           styleClass="ui-button-success" />
            <p:commandButton value="Cancelar"
                           onclick="PF('editDialog').hide()"
                           type="button"
                           styleClass="ui-button-secondary" />
        </div>
    </h:form>
</p:dialog>

    <!-- Dialog de Confirmação -->
    <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
        <p:commandButton value="Sim" type="button" styleClass="ui-confirmdialog-yes" icon="pi pi-check"/>
        <p:commandButton value="Não" type="button" styleClass="ui-confirmdialog-no" icon="pi pi-times"/>
    </p:confirmDialog>

    <!-- Polling automático para verificar mudanças nos agendamentos -->
<h:panelGroup id="pollPanel">
    <h:panelGrid rendered="#{agendaController.sistemaAtualizacaoAtivo}">
        <h:form id="pollingForm">
            <p:poll interval="60"
                    widgetVar="poll"
                    listener="#{agendaController.verificarMudancasEAtualizar}"
                    update=":consultasForm:consultasTable"
                    autoStart="true"
                    global="false"
                    async="true"
                    onstart="window.isSystemPolling = true; console.log('Polling iniciado');"
                    oncomplete="window.isSystemPolling = false; console.log('Polling completado');" />
        </h:form>
    </h:panelGrid>
</h:panelGroup>
    
    <!-- Loaders específicos por ação -->
    <!-- Loader para agendar consulta -->
    <div id="loader-agendar" class="action-loader" style="display:none;">
        <div class="loader-content">
            <div class="custom-spinner"></div>
            <div class="custom-loader-text">Agendando consulta...</div>
        </div>
    </div>
    
    <!-- Loader para editar consulta -->
    <div id="loader-editar" class="action-loader" style="display:none;">
        <div class="loader-content">
            <div class="custom-spinner"></div>
            <div class="custom-loader-text">Editando consulta...</div>
        </div>
    </div>
    
    <!-- Loader para excluir consulta -->
    <div id="loader-excluir" class="action-loader" style="display:none;">
        <div class="loader-content">
            <div class="custom-spinner"></div>
            <div class="custom-loader-text">Excluindo consulta...</div>
        </div>
    </div>
    
    <!-- Loader para finalizar consulta -->
    <div id="loader-finalizar" class="action-loader" style="display:none;">
        <div class="loader-content">
            <div class="custom-spinner"></div>
            <div class="custom-loader-text">Finalizando consulta...</div>
        </div>
    </div>
    
    <!-- Loader para cancelar consulta -->
    <div id="loader-cancelar" class="action-loader" style="display:none;">
        <div class="loader-content">
            <div class="custom-spinner"></div>
            <div class="custom-loader-text">Cancelando consulta...</div>
        </div>
    </div>
    
    <!-- Loader para visualizar detalhes -->
    <div id="loader-detalhes" class="action-loader" style="display:none;">
        <div class="loader-content">
            <div class="custom-spinner"></div>
            <div class="custom-loader-text">Carregando detalhes...</div>
        </div>
    </div>
    
    <!-- Loader para buscar -->
    <div id="loader-buscar" class="action-loader" style="display:none;">
        <div class="loader-content">
            <div class="custom-spinner"></div>
            <div class="custom-loader-text">Buscando...</div>
        </div>
    </div>
    
    <h:outputScript>
    // Funções para controlar os loaders específicos com tempo mínimo de 0.3 segundos
    function showLoaderAgendar() {
        document.getElementById('loader-agendar').style.display = 'flex';
        window.loaderAgendarStartTime = Date.now();
    }
    function hideLoaderAgendar() {
        var elapsed = Date.now() - window.loaderAgendarStartTime;
        var remaining = Math.max(0, 300 - elapsed);
        setTimeout(function() {
            document.getElementById('loader-agendar').style.display = 'none';
        }, remaining);
    }

    function showLoaderEditar() {
        document.getElementById('loader-editar').style.display = 'flex';
        window.loaderEditarStartTime = Date.now();
    }
    function hideLoaderEditar() {
        var elapsed = Date.now() - window.loaderEditarStartTime;
        var remaining = Math.max(0, 300 - elapsed);
        setTimeout(function() {
            document.getElementById('loader-editar').style.display = 'none';
        }, remaining);
    }

    function showLoaderExcluir() {
        document.getElementById('loader-excluir').style.display = 'flex';
        window.loaderExcluirStartTime = Date.now();
    }
    function hideLoaderExcluir() {
        var elapsed = Date.now() - window.loaderExcluirStartTime;
        var remaining = Math.max(0, 300 - elapsed);
        setTimeout(function() {
            document.getElementById('loader-excluir').style.display = 'none';
        }, remaining);
    }

    function showLoaderFinalizar() {
        document.getElementById('loader-finalizar').style.display = 'flex';
        window.loaderFinalizarStartTime = Date.now();
    }
    function hideLoaderFinalizar() {
        var elapsed = Date.now() - window.loaderFinalizarStartTime;
        var remaining = Math.max(0, 300 - elapsed);
        setTimeout(function() {
            document.getElementById('loader-finalizar').style.display = 'none';
        }, remaining);
    }

    function showLoaderCancelar() {
        document.getElementById('loader-cancelar').style.display = 'flex';
        window.loaderCancelarStartTime = Date.now();
    }
    function hideLoaderCancelar() {
        var elapsed = Date.now() - window.loaderCancelarStartTime;
        var remaining = Math.max(0, 300 - elapsed);
        setTimeout(function() {
            document.getElementById('loader-cancelar').style.display = 'none';
        }, remaining);
    }

    function showLoaderDetalhes() {
        document.getElementById('loader-detalhes').style.display = 'flex';
        window.loaderDetalhesStartTime = Date.now();
    }
    function hideLoaderDetalhes() {
        var elapsed = Date.now() - window.loaderDetalhesStartTime;
        var remaining = Math.max(0, 300 - elapsed);
        setTimeout(function() {
            document.getElementById('loader-detalhes').style.display = 'none';
        }, remaining);
    }

    function showLoaderBuscar() {
        document.getElementById('loader-buscar').style.display = 'flex';
        window.loaderBuscarStartTime = Date.now();
    }
    function hideLoaderBuscar() {
        var elapsed = Date.now() - window.loaderBuscarStartTime;
        var remaining = Math.max(0, 300 - elapsed);
        setTimeout(function() {
            document.getElementById('loader-buscar').style.display = 'none';
        }, remaining);
    }

    // Manter as funções originais para ações fora de dialogs
    function showLoaderAndDisable(btnId) {
        PF('globalLoader').show();
    }
    function hideLoaderAndEnable(btnId) {
        PF('globalLoader').hide();
    }
    </h:outputScript>
    </div>
</h:body>
</html>
